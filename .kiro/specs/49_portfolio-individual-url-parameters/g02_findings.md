# G02 Verification Findings: Portfolio Individual URL Parameter Mismatch

**Date**: 2025-10-26
**Reporter**: User
**Verification Method**: G02 - Verifying Portfolio Backtest Results

## Bug Report Summary

Portfolio backtest individual result URLs are generated with **default parameters** instead of the **actual parameters used** by the portfolio, causing completely different backtest results when clicked.

## Evidence

### Test Case: NVDA Portfolio Backtest

**Portfolio Frontend URL**:
```
stocks=TSLA,AMZN,META,GOOG,MSFT,NVDA,AAPL
totalCapital=500000
lotSize=20000
maxLots=5
momentumBasedBuy=true
momentumBasedSell=true
enableBetaScaling=true
coefficient=0.5
```

### Step 2: Backend API Payload (Portfolio Run)

**Actual Parameters Sent to Backend for NVDA**:
```json
{
  "portfolioRunId": "1761511795997-h6epmmxwq",
  "lotSizeUsd": 20000,                                 // ‚Üê PORTFOLIO ACTUAL
  "maxLots": 5,                                         // ‚Üê PORTFOLIO ACTUAL
  "gridIntervalPercent": 0.10615000000000002,          // ‚Üê BETA-SCALED
  "profitRequirement": 0.10615000000000002,            // ‚Üê BETA-SCALED
  "trailingBuyActivationPercent": 0.10615000000000002,  // ‚Üê BETA-SCALED
  "trailingBuyReboundPercent": 0.05307500000000001,    // ‚Üê BETA-SCALED
  "trailingSellActivationPercent": 0.21230000000000004,// ‚Üê BETA-SCALED
  "trailingSellPullbackPercent": 0.10615000000000002,  // ‚Üê BETA-SCALED
  "gridConsecutiveIncrement": 0.05307500000000001,     // ‚Üê BETA-SCALED
  "momentumBasedBuy": true,
  "momentumBasedSell": true
}
```

**Portfolio Result**:
- **Only 1 BUY transaction** on December 7, 2021 at $32.37
- Total Return: $93,217.21 (+466.09%)

### Step 3: Individual Result URL (From Portfolio)

**URL Parameters Generated by Portfolio**:
```json
{
  "lotSizeUsd": 10000,                    // ‚ùå WRONG! Should be 20000
  "maxLots": 10,                          // ‚ùå WRONG! Should be 5
  "gridIntervalPercent": 0.1,             // ‚ùå WRONG! Should be 0.10615
  "profitRequirement": 0.1,               // ‚ùå WRONG! Should be 0.10615
  "trailingBuyActivationPercent": 0.1,    // ‚ùå WRONG! Should be 0.10615
  "trailingBuyReboundPercent": 0.05,      // ‚ùå WRONG! Should be 0.053075
  "trailingSellActivationPercent": 0.2,   // ‚ùå WRONG! Should be 0.2123
  "trailingSellPullbackPercent": 0.1,     // ‚ùå WRONG! Should be 0.10615
  "gridConsecutiveIncrement": 0.05,       // ‚ùå WRONG! Should be 0.053075
  "momentumBasedBuy": true,               // ‚úÖ CORRECT
  "momentumBasedSell": true               // ‚úÖ CORRECT
}
```

**Standalone Result (using wrong params)**:
- **Multiple BUY transactions** starting September 23, 2021 at $22.44
- Total Return: $347,669.99 (+347.67%)

### Step 4-5: Comparison

| Metric | Portfolio (Actual) | Standalone (URL) | Match? |
|--------|-------------------|------------------|--------|
| **lotSizeUsd** | 20,000 | 10,000 | ‚ùå NO |
| **maxLots** | 5 | 10 | ‚ùå NO |
| **Grid Interval** | 10.615% | 10% | ‚ùå NO |
| **First Transaction** | Dec 7, 2021 | Sep 23, 2021 | ‚ùå NO |
| **Transaction Count** | 1 | Multiple | ‚ùå NO |
| **Total Return** | +466% | +348% | ‚ùå NO |
| **Momentum Mode** | true | true | ‚úÖ YES |

## Root Cause Analysis

The individual result URL generator is using:
1. **Default parameters** from config file
2. **NOT** the actual portfolio parameters (including beta-scaled values)

This causes:
- Wrong lot sizes
- Wrong position limits
- Wrong grid parameters
- Completely different backtest results

## Impact

**Severity**: üî¥ **CRITICAL**

Users clicking "View Individual Result" from portfolio results will see:
- ‚ùå Wrong backtest simulation
- ‚ùå Wrong transaction history
- ‚ùå Wrong returns
- ‚ùå Unable to reproduce portfolio results for verification

This breaks the fundamental G02 verification requirement that **portfolio individual results must match standalone results with identical parameters**.

## Success Criteria for Fix

- ‚úÖ Individual result URL uses **exact parameters** from portfolio run
- ‚úÖ Individual result URL includes **beta-scaled parameters** when applicable
- ‚úÖ Standalone backtest using individual URL produces **identical results** to portfolio
- ‚úÖ G02 verification passes: Step 5 comparison shows 100% match

## Related Issues

This bug is related to **Spec 48** (momentum parameters missing from portfolio payload), but this is a **separate issue** affecting ALL parameters, not just momentum.

## Deep Dive Investigation Results (2025-10-26)

Following user's instruction to "continue to make sure both should give the same result", I ran portfolio and standalone with **EXACT SAME PARAMETERS** and discovered:

### Bug #3: Portfolio Execution Logic Mismatch

**Even with identical parameters, portfolio and standalone produce different results!**

#### Evidence:

**Test Configuration** (NVDA, both modes):
- lotSizeUsd: $20,000
- maxLots: 5
- gridIntervalPercent: 0.10615 (beta-scaled)
- momentumBasedBuy: true, momentumBasedSell: true

#### Results:

| Metric | Portfolio | Standalone | Match? |
|--------|----------|------------|--------|
| **Total BUYs** | 2 | 5 | ‚ùå NO |
| **First BUY Date** | Dec 27, 2021 | Dec 7, 2021 | ‚ùå NO (20 days off!) |
| **First BUY Price** | $30.89 | $32.37 | ‚ùå NO |
| **buyGridSize** | 0.2123 | 0.10615 | ‚ùå NO (2√ó wrong!) |

#### Root Cause:

Portfolio mode shows `buyGridSize: 0.2123` in transaction data, but this value is:
- Exactly `trailingSellActivationPercent` (0.2123)
- Exactly 2√ó `gridIntervalPercent` (0.10615)

**Portfolio is confusing BUY and SELL parameters!**

**Location**: `/Users/kweng/AI/DCA-Backtest-Tool/backend/services/portfolioBacktestService.js:279-311`

**Impact**: All portfolio backtests with momentum + beta scaling return completely different results from standalone mode, even with identical parameters.

**Full Analysis**: See `bug3_execution_logic_mismatch.md`

---

**Verified by**: G02 Process
**Next Step**: Fix all 3 bugs:
1. **Bug #1**: Fix portfolio individual URL parameter generation
2. **Bug #2**: Fix momentum mode maxLots interpretation (Spec 45)
3. **Bug #3**: Fix portfolio parameter application bug (buyGridSize using wrong value)
